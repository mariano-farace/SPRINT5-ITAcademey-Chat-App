const { google } = require('googleapis');
const axios = require('axios');
const jwt = require('jsonwebtoken');
const User = require('../models/User');

const {
  GOOGLE_CLIENT_ID,
  GOOGLE_CLIENT_SECRET,
  SERVER_ROOT_URI,
  CLIENT_ROOT_URI,
  JWT_SECRET,
  COOKIE_NAME,
  REDIRECT_URL,
} = require('../config');
/**
 * Create the google auth object which gives us access to talk to google's apis.
 * Will connect to Google when we want it to
 */
// TODO crear funcion y llamarla en el lugar que se necesita
const oauth2Client = new google.auth.OAuth2(
  GOOGLE_CLIENT_ID,
  GOOGLE_CLIENT_SECRET,
  REDIRECT_URL,
);

/**
Function to get the auth URL. Esta es la url que el usuario hace click para loguearse!
 */

function getGoogleAuthURL() {
  /*
  * Generate a url that asks permissions to the user's email and profile
  *
  *When the user clicks the link generated by the function getGoogleAuthURL, they will
  *give permission to your application and be redirected to the URL that you
  *specified as the 3rd argument in oauth2Client.
   */
  const scopes = [
    'https://www.googleapis.com/auth/userinfo.profile',
    'https://www.googleapis.com/auth/userinfo.email',
  ];

  return oauth2Client.generateAuthUrl({
    access_type: 'offline',
    prompt: 'consent',
    scope: scopes, // If you only need one scope you can pass it as string
  });
}

/*
Function that fetches the bearer token with the code, then fetches the userâ€™s profile
*/
async function getGoogleUser({ code }) {
  const { tokens } = await oauth2Client.getToken(code);
  console.log('tokens', tokens);
  // Fetch the user's profile with the access token and bearer
  const googleUser = await axios
    .get(
      `https://www.googleapis.com/oauth2/v1/userinfo?alt=json&access_token=${tokens.access_token}`,
      {
        headers: {
          Authorization: `Bearer ${tokens.id_token}`,
        },
      },
    )
    .then((res) => res.data)
    .catch((error) => {
      throw new Error(error.message);
    });

  return googleUser;
}

async function googleAuthLog(req, res) {
  const { code } = req.query;
  console.log('el puto codigo: ', code);
  const googleUser = await getGoogleUser({ code });
  console.log('result de getGoogleUser:::', googleUser);
  try {
    let user = await User.findOne({ email: googleUser.email });
    if (!user) {
      console.log('el user no existe, crea uno');
      user = await User.create({ name: googleUser.name, email: googleUser.email, password: 'isOauth: true' });
    }
    const maxAge = (24 * 60 * 60);

    const token = jwt.sign({ user }, 'chatroom secret', {
      expiresIn: maxAge,
    });
    res.cookie(COOKIE_NAME, token, { httpOnly: true, maxAge: maxAge * 1000 });
    res.redirect(CLIENT_ROOT_URI);
    // res.status(201).json({ user });

    console.log('el user existe');
    console.log(user);
  } catch (error) {
    console.log(error);
    res.status(400).json(error);
  }
}

async function verifyGoogleAuthToken(req, res) {
  console.log('google-login-redirect Route!');
  try {
    const decodedToken = jwt.verify(req.cookies[COOKIE_NAME], 'chatroom secret');
    const { user } = decodedToken;
    res.status(201).json(user);
  } catch (err) {
    console.log(err);
    res.send(null);
  }
}

module.exports = {
  getGoogleAuthURL, getGoogleUser, googleAuthLog, verifyGoogleAuthToken,
};
